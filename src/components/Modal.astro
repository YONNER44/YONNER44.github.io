---
import { HiOutlineCog } from "react-icons/hi";
// filepath: src/components/Modal.astro
const { title = "Configuración" } = Astro.props;
---

<div
  id="config-modal"
  class="hidden absolute top-full right-0 mt-2 z-50 opacity-0 scale-95 transition-all duration-300 ease-out"
>
  <div
    class="bg-black dark:bg-white rounded-3xl shadow-2xl p-6 sm:p-8 w-80 sm:w-96 relative"
  >
    <button
      type="button"
      class="absolute top-3 right-3 p-2 rounded-full  flex items-center justify-center text-white dark:text-black  transition-transform duration-300 ease-in-out
         hover:rotate-90 hover:scale-110"
      aria-label="Cerrar"
    >
      <span aria-hidden="true" class="text-2xl leading-none">&times;</span>
    </button>
    <h2 class="flex items-center gap-2 text-2xl font-bold mb-4 text-white dark:text-black">
     <HiOutlineCog className="w-7 h-7 text-white dark:text-black" />
     {title}
    </h2>
    <form id="clave-form" class="flex flex-col gap-4 items-stretch mt-2">
      <button
        id="solicitar-clave"
        type="button"
        class="w-full py-3 px-4 text-left font-bold rounded-2xl border-1 shadow-lg text-black dark:text-white bg-white dark:bg-black transition duration-300 transform hover:scale-105 hover:shadow-xl"
        >Solicitar clave.</button
      >
      <input
        id="clave"
        name="clave"
        type="text"
        required
        placeholder="Ingresa la clave recibida"
        class="w-full py-3 px-4 font-bold placeholder:text-gray-400 rounded-2xl focus:outline-noneaaaa border-1 shadow-lg text-black dark:text-white bg-white dark:bg-black transition duration-300 transform hover:scale-105 hover:shadow-xl"
        disabled
      />
      <button
        id="validar-clave"
        type="submit"
        class="w-full py-3 px-4 text-left font-bold rounded-2xl border-1 shadow-lg text-black dark:text-white bg-white dark:bg-black transition duration-300 transform hover:scale-105 hover:shadow-xl"
        disabled>Validar clave.</button
      >
      <div
        id="respuesta-modal"
        class="min-h-12 px-4 py-3 rounded-2xl text-sm font-semibold text-center opacity-0 transition-all duration-500 ease-in-out"
        style="display: none;"
      ></div>
    </form>
    <slot />
  </div>
</div>

<script>
import { apiService } from "../services/api.service";
  import { authUtils } from "../utils/auth.utils";

  if (typeof window !== "undefined") {
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("clave-form") as HTMLFormElement;
      const solicitarBtn = document.getElementById("solicitar-clave") as HTMLButtonElement;
      const validarBtn = document.getElementById("validar-clave") as HTMLButtonElement;
      const claveInput = document.getElementById("clave") as HTMLInputElement;
      const respuestaDiv = document.getElementById("respuesta-modal") as HTMLDivElement;

      const mostrarRespuesta = (mensaje: string, esError: boolean = false) => {
        respuestaDiv.textContent = mensaje;
        respuestaDiv.style.display = "block";
        respuestaDiv.classList.remove("bg-green-500", "bg-red-500");
        if (esError) {
          respuestaDiv.classList.add("bg-red-500", "text-white");
        } else {
          respuestaDiv.classList.add("bg-green-500", "text-white");
        }

        respuestaDiv.offsetHeight; // Forzar reflow para reiniciar la animación
        respuestaDiv.style.opacity = "1";

 setTimeout(() => {
  respuestaDiv.style.opacity = "0";
  setTimeout(() => {
    ocultarRespuesta();
  }, 500);
  }, 3000);

      };

      const ocultarRespuesta = () => {
        respuestaDiv.style.display = "none";
        respuestaDiv.style.opacity = "0";
        respuestaDiv.textContent = "";
      };

      if (solicitarBtn && claveInput && validarBtn && form) {
        solicitarBtn.addEventListener("click", async () => {
          solicitarBtn.disabled = true;
          solicitarBtn.textContent = "Enviando...";
          ocultarRespuesta();

          try {
            const response = await apiService.requestPassword();

            if (response.success) {
              mostrarRespuesta(response.message);
              claveInput.disabled = false;
              validarBtn.disabled = false;
              solicitarBtn.disabled = true;
            } else {
              mostrarRespuesta(response.message, true);
              solicitarBtn.disabled = false;
              solicitarBtn.textContent = "Solicitar clave.";
            }
          } catch (err: any) {
            mostrarRespuesta(err.message || "Error desconocido", true);
            solicitarBtn.disabled = false;
            solicitarBtn.textContent = "Solicitar clave.";
          }
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          const clave = claveInput.value.trim();
          if (!clave) {
            return;
          }

          validarBtn.disabled = true;
          validarBtn.textContent = "Validando...";
          ocultarRespuesta();

          try {
            const response = await apiService.validatePassword(clave);

            if (response.success && response.valid && response.token) {
  mostrarRespuesta(response.message);
  // Guardar el token
  localStorage.setItem('authToken', response.token);
  // También guardar en cookie para que el middleware lo pueda leer
  document.cookie = `authToken=${response.token}; path=/; max-age=86400`;
  setTimeout(() => {
    window.location.href = "/projectsConfig/internshipConfig";
  }, 1000);
            } else {
              mostrarRespuesta(response.message, true);
              validarBtn.disabled = false;
              validarBtn.textContent = "Validar clave.";
              claveInput.value = "";
            }
          } catch (err: any) {
            mostrarRespuesta(err.message || "Error desconocido", true);
            validarBtn.disabled = false;
            validarBtn.textContent = "Validar clave.";
          }
        });
      }
    });
  }
</script>
